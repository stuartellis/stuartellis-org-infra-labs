# SPDX-FileCopyrightText: 2024-present Stuart Ellis <stuart@stuartellis.name>
#
# SPDX-License-Identifier: MIT
#
# Configuration for GitLab pipelines
#
# See: https://docs.gitlab.com/ee/ci/pipelines/

stages:
  - validate
  - plan
#  - apply_review
#  - apply_release

variables:
  MISE_ENV: ci
  MISE_PARANOID: 1
  STACK: compute-coracle
  VARIANT: default

default:
  image: alpine:3.20.0

before_script:
  - apk update
  - apk upgrade --no-cache --no-interactive
  - apk add --no-cache --no-interactive bash curl git gnupg mise
  - mise trust .mise.ci.toml
  - mise install --quiet task

validate:
  stage: validate
  script:
    - mise install --quiet terraform
    - mise exec task --command "task stack:init"
    - mise exec task --command "task stack:validate"
  variables:
    ENV: validate

plan_dev:
  stage: plan
  script:
    - mise install --quiet terraform
    - mise exec task --command "task stack:init"
    - mise exec task --command "task stack:plan"
  variables:
    ENV: dev
