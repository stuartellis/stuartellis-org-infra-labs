# SPDX-FileCopyrightText: 2024-present Stuart Ellis <stuart@stuartellis.name>
#
# SPDX-License-Identifier: MIT
#
# Configuration for GitLab pipelines
#
# See: https://docs.gitlab.com/ee/ci/pipelines/

stages:
  - pre_commit

variables:
  PRODUCT_NAME: labs
  STACK: compute-coracle
  VARIANT: default
  CI_PYTHON_IMAGE: python:3.12.4-slim-bookworm
  TRIVY_NO_PROGRESS: "true"
  TRIVY_CACHE_DIR: ".trivycache/"

default:
  image: alpine:3.20.2

pre_commit:
  stage: pre_commit
  image: $CI_PYTHON_IMAGE
  before_script:
    - apt update -qy
    - apt install -qy curl git
    - apt-get install -qy --no-install-recommends apt-transport-https gnupg lsb-release
    - curl -L https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor > /usr/share/keyrings/trivy.gpg
    - echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" > /etc/apt/sources.list.d/trivy.list
    - apt-get update
    - apt-get install -qy trivy
  script:
    - python3 -m pip install --upgrade pip
    - python3 -m pip install pre-commit
    - pre-commit run
  variables:
    ENV: pre_commit
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
    PIP_ROOT_USER_ACTION: ignore
    PRE_COMMIT_HOME: "$CI_PROJECT_DIR/.cache/pre-commit"
    TRIVY_NO_PROGRESS: "true"
    TRIVY_CACHE_DIR: ".trivycache/"
  cache:
    - key: pip
      paths:
        - ${PIP_CACHE_DIR}
    - key: pre-commit
      paths:
        - ${PRE_COMMIT_HOME}
    - key: trivy
      paths:
        - ${TRIVY_CACHE_DIR}
