stages:
- plan
- deploy
- tag

variables:
  ENVIRONMENT: dev
  SUBSYSTEM_NAME: canary
  STACK_NAME: infra-one
  STACK_VARIANT: default
  RELEASE_VERSION: 0.0.0

plan:
  image: alpine:3.17.3
  stage: plan
  before_script:
    - apk add make
  script:
    - make terraform-plan

deploy:
  image: alpine:3.17.3
  stage: deploy
  before_script:
    - apk add make
  script:
    - make terraform-apply
  environment:
    name: $ENVIRONMENT-$STACK_NAME
  release:
    tag_name: $ENVIRONMENT-$STACK_NAME-$RELEASE_VERSION
    description: 'Release'

tag:
  image: alpine:3.17.3
  stage: tag
  before_script:
    - apk add make
  script:
    - make tag
  release:
    tag_name: $ENVIRONMENT-$SUBSYSTEM_NAME-$RELEASE_VERSION
    description: 'Subsystem Release'
